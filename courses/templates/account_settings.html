{% extends "base.html" %}
{% load crispy_forms_tags %}
{% load static %}

{% block auth_content %}
<div class="container mt-4">
    <div class="content-card p-4">
        <h2 class="text-info mb-4">
            <i class="bi bi-gear-fill me-2"></i>Account Settings
        </h2>

        <!-- Tabs -->
        <ul class="nav nav-tabs" id="settingsTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile"
                        type="button" role="tab" aria-controls="profile" aria-selected="true">
                    <i class="bi bi-person-circle me-1"></i> Profile Settings
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="password-tab" data-bs-toggle="tab" data-bs-target="#password"
                        type="button" role="tab" aria-controls="password" aria-selected="false">
                    <i class="bi bi-shield-lock-fill me-1"></i> Change Password
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content mt-4" id="settingsTabsContent">

            <!-- Profile Settings -->
            <div class="tab-pane fade show active" id="profile" role="tabpanel" aria-labelledby="profile-tab">
                <form method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    {{ user_form|crispy }}
                    {{ profile_form|crispy }}

                    <!-- Avatar Preview -->
                    {% if request.user.account_profile.avatar %}
                        <div class="mb-3 text-center">
                            <img src="{{ request.user.account_profile.avatar.url }}"
                                 alt="{{ user.username }}'s avatar"
                                 class="rounded-circle shadow"
                                 style="width: 120px; height: 120px; object-fit: cover;">
                        </div>
                    {% endif %}

                    <button type="submit" name="update_profile" class="btn btn-info">
                        <i class="bi bi-save me-1"></i> Save Changes
                    </button>
                </form>
            </div>

            <!-- Change Password -->
            <div class="tab-pane fade" id="password" role="tabpanel" aria-labelledby="password-tab">
                <form method="POST">
                    {% csrf_token %}
                    {{ password_form|crispy }}

                    <button type="submit" name="change_password" class="btn btn-warning">
                        <i class="bi bi-key-fill me-1"></i> Update Password
                    </button>
                </form>
            </div>
        </div>

        <!-- Danger Zone -->
        <div class="mt-5">
            <div class="card border-danger shadow">
                <div class="card-body text-center">
                    <h4 class="text-danger"><i class="bi bi-exclamation-triangle-fill me-2"></i>Danger Zone</h4>
                    <p class="text-muted">Once you delete your account, there is no going back. Please confirm your decision.</p>

                    <form method="POST" onsubmit="return confirm('⚠️ Are you sure you want to permanently delete your account? This action cannot be undone.');">
                        {% csrf_token %}
                        {{ delete_form.confirm }}
                        <div class="form-check">
                            {{ delete_form.confirm_deletion }}
                            <label class="form-check-label" for="id_confirm_deletion">
                                I understand the consequences, delete my account.
                            </label>
                        </div>      

                        <button type="submit" name="delete_account" class="btn btn-danger mt-3">
                            <i class="bi bi-trash-fill me-1"></i> Delete Account
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block guest_content %}
<div class="container mt-5">
    <div class="content-card p-5 text-center shadow-sm">
        <i class="bi bi-lock-fill display-3 text-warning mb-3"></i>
        <h2 class="text-warning">Restricted Area</h2>
        <p class="text-muted">You need to log in to manage your account settings.</p>
        <div class="mt-3">
            <a href="{% url 'login' %}" class="btn btn-info me-2">
                <i class="bi bi-box-arrow-in-right me-1"></i> Login
            </a>
            <a href="{% url 'signup' %}" class="btn btn-outline-primary">
                <i class="bi bi-person-plus-fill me-1"></i> Create Account
            </a>
        </div>
    </div>
</div>
{% endblock %}
